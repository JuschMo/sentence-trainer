<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sentence Trainer</title>
  <style>
    :root{
      --bg:#0f172a;        /* slate-900 */
      --fg:#e2e8f0;        /* slate-200 */
      --muted:#94a3b8;     /* slate-400 */
      --accent:#22d3ee;    /* cyan-400 */
      --good:#34d399;      /* emerald-400 */
      --warn:#fbbf24;      /* amber-400 */
      --danger:#fb7185;    /* rose-400 */
      --card:#111827;      /* gray-900 */
      --btn:#1f2937;       /* gray-800 */
    }
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 70% -20%, #1e293b, transparent), var(--bg);
      color:var(--fg); display:grid; place-items:center;
    }
    .app{ width: min(1100px, 92vw); }
    .card{ background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.08);
           border-radius:18px; padding:22px; box-shadow:0 10px 30px rgba(0,0,0,0.35); }
    h1{ margin:0 0 12px; font-weight:800; letter-spacing:0.2px; }
    p.muted{ color:var(--muted); margin-top:6px }
    textarea{ width:100%; min-height:260px; border-radius:12px; background:#0b1220; color:var(--fg); border:1px solid rgba(255,255,255,0.12);
              padding:14px; font-size:18px; line-height:1.5; resize:vertical; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .btn{ background:var(--btn); color:#fff; border:1px solid rgba(255,255,255,0.14); padding:12px 16px; border-radius:12px; font-size:16px;
          cursor:pointer; transition: transform .06s ease, background .2s ease, border-color .2s ease; }
    .btn:hover{ transform:translateY(-1px); border-color:rgba(255,255,255,0.25) }
    .btn:disabled{ opacity:.45; cursor:not-allowed; transform:none }
    .btn.primary{ background: linear-gradient(180deg, #22d3ee, #06b6d4); color:#00212a; font-weight:700; border:none }
    .btn.ghost{ background:transparent; border:1px dashed rgba(255,255,255,0.25) }
    .chips{ display:flex; gap:10px; flex-wrap:wrap; margin:.5rem 0 0 }
    .chip{ background:#0b1220; padding:6px 10px; border:1px solid rgba(255,255,255,.12); border-radius:999px; font-size:12px; color:var(--muted) }

    /* Viewer */
    .viewer{ display:none }
    .hud{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px }
    .count{ font-variant-numeric:tabular-nums; letter-spacing:1px; font-weight:800; }
    .count.badge{ background:#0b1220; border:1px solid rgba(255,255,255,0.12); padding:8px 12px; border-radius:999px }
    .count.show{ color:var(--good) }
    .count.blank{ color:var(--warn) }
    .count.idle{ color:var(--muted) }
    .progress{ height:6px; background:#0b1220; border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,.08) }
    .progress > div{ height:100%; width:0%; background: linear-gradient(90deg, #22d3ee, #34d399); transition: width .1s linear }

    .sentence{ font-size: clamp(28px, 5vw, 54px); line-height:1.2; text-align:center; min-height: 6lh; display:grid; place-items:center; padding: 28px; border-radius:18px; border:1px solid rgba(255,255,255,.08);
               background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); }
    .write{ font-weight:900; letter-spacing: 2px; font-size: clamp(34px, 6vw, 72px); color:var(--accent); text-align:center }

    .footer{ display:flex; justify-content:space-between; align-items:center; margin-top:14px; gap:12px; flex-wrap:wrap }
    .index{ color:var(--muted) }
    .kbd{ font-variant-numeric: tabular-nums; background:#0b1220; border:1px solid rgba(255,255,255,.15); padding:2px 6px; border-radius:6px }

    @media (max-width:600px){ .sentence{ min-height: 5lh } }
  </style>
</head>
<body>
  <div class="app">
    <!-- Setup screen -->
    <section id="setup" class="card">
      <h1>Sentence Trainer</h1>
      <p class="muted">Paste or type one sentence per line. Click <strong>OK</strong> to start. On each slide: the sentence shows for <strong>5s</strong> with a countdown, hides for <strong>3s</strong> (countdown), then shows <em>Write</em>. Use <span class="kbd">Space</span> or the <strong>Next</strong> button to proceed.</p>
      <textarea id="input" placeholder="Type one sentence per lineâ€¦&#10;Ich spiele gern FuÃŸball.&#10;Am Wochenende besuche ich meine GroÃŸeltern.&#10;â€¦"></textarea>
      <div class="row" style="margin-top:12px">
        <button id="startBtn" class="btn primary">OK</button>
        <button id="demoBtn" class="btn">Load demo</button>
        <button id="clearBtn" class="btn ghost">Clear</button>
        <div class="chips" aria-hidden="true">
          <span class="chip">5s show</span>
          <span class="chip">3s blank</span>
          <span class="chip">then <strong>Write</strong></span>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <h2 style="margin:0 0 8px;font-size:18px">Textâ€‘toâ€‘Speech (optional)</h2>
        <p class="muted" id="ttsSupportNote">Enable this to have each sentence read aloud during the <em>Show</em> phase and when it reappears.</p>
        <div class="row" id="ttsControls">
          <label class="row" style="gap:8px;align-items:center">
            <input type="checkbox" id="ttsEnabled"/>
            <span>Read sentences aloud</span>
          </label>
          <select id="voiceSelect" title="Voice" disabled></select>
          <label>Rate <input type="range" id="rate" min="0.5" max="1.5" step="0.1" value="1" disabled></label>
          <label>Pitch <input type="range" id="pitch" min="0.5" max="2" step="0.1" value="1" disabled></label>
          <button id="testVoice" class="btn" disabled>Test voice</button>
        </div>
      </div>
    </section>

    <!-- Viewer screen -->
    <section id="viewer" class="viewer">
      <div class="hud">
        <div class="index" id="indexLabel">Sentence 1 / 1</div>
        <div class="row" style="margin-left:auto;gap:8px;align-items:center">
          <button id="muteBtn" class="btn" title="Mute / unmute TTS">ðŸ”Š</button>
          <div class="count badge idle" id="countdown">Ready</div>
        </div>
      </div>
      <div class="progress" aria-hidden="true"><div id="bar"></div></div>

      <div id="stage" class="sentence" role="region" aria-live="polite"></div>

      <div class="footer">
        <div class="row">
          <button id="nextBtn" class="btn" disabled>Next â–¸</button>
          <button id="restartBtn" class="btn">â†» Restart</button>
          <button id="backBtn" class="btn">â—‚ Back to input</button>
        </div>
        <div class="muted">Tip: press <span class="kbd">Space</span> for Next</div>
      </div>
    </section>
  </div>

  <script>
    // Simple single-file SPA
    const setup = document.getElementById('setup');
    const viewer = document.getElementById('viewer');
    const input = document.getElementById('input');
    const startBtn = document.getElementById('startBtn');
    const demoBtn = document.getElementById('demoBtn');
    const clearBtn = document.getElementById('clearBtn');

    const indexLabel = document.getElementById('indexLabel');
    const stage = document.getElementById('stage');
    const countdown = document.getElementById('countdown');
    const bar = document.getElementById('bar');
    const nextBtn = document.getElementById('nextBtn');
    const restartBtn = document.getElementById('restartBtn');
    const backBtn = document.getElementById('backBtn');
    const muteBtn = document.getElementById('muteBtn');

    let sentences = [];
    let i = 0;                 // current sentence index
    let phase = 'idle';        // 'show'|'blank'|'write'|'again'|'idle'
    let timer = null;          // interval id
    let t0 = 0, dur = 0;       // timing

    // === TTS state ===
    const ttsEnabled = document.getElementById('ttsEnabled');
    const voiceSelect = document.getElementById('voiceSelect');
    const rateInput = document.getElementById('rate');
    const pitchInput = document.getElementById('pitch');
    const testVoiceBtn = document.getElementById('testVoice');
    const tts = { enabled:false, muted:false, voice:null, rate:1, pitch:1, volume:1 };

    function parseSentences(text){
      // Robustly split on Windows (\r\n), Unix (\n), or classic Mac (\r) newlines
      return text
        .split(/\r?\n|\r/)
        .map(s => s.trim())
        .filter(Boolean);
    }

    function gotoViewer(list){
      sentences = list;
      i = 0;
      setup.style.display = 'none';
      viewer.style.display = 'block';
      startSentenceCycle();
    }

    function updateIndex(){
      indexLabel.textContent = `Sentence ${i+1} / ${sentences.length}`;
    }

    function setCountdownLabel(txt, cls){
      countdown.textContent = txt;
      countdown.className = `count badge ${cls}`;
    }

    function animateBar(progress){
      bar.style.width = `${Math.max(0, Math.min(100, progress*100))}%`;
    }

    function startTimer(ms, tickLabel, cls, onDone){
      clearInterval(timer);
      t0 = performance.now();
      dur = ms;
      animateBar(0);
      timer = setInterval(()=>{
        const now = performance.now();
        const elapsed = now - t0;
        const remain = Math.max(0, ms - elapsed);
        const s = Math.ceil(remain/1000);
        setCountdownLabel(`${tickLabel}: ${s}s`, cls);
        animateBar(elapsed / ms);
        if(remain <= 0){
          clearInterval(timer);
          animateBar(1);
          onDone && onDone();
        }
      }, 100);
    }

    // ---------- TTS helpers ----------
    function loadVoices(){
      if(!('speechSynthesis' in window)) return;
      const voices = window.speechSynthesis.getVoices();
      voiceSelect.innerHTML = '';
      for(const v of voices){
        const opt = document.createElement('option');
        opt.value = v.name;
        opt.textContent = `${v.name} (${v.lang})`;
        voiceSelect.appendChild(opt);
      }
      const savedName = localStorage.getItem('sentence-trainer:voice');
      if(savedName){
        const found = Array.from(voiceSelect.options).find(o=>o.value===savedName);
        if(found){ voiceSelect.value = savedName; tts.voice = voices.find(v=>v.name===savedName)||null; }
      } else if(voices.length){
        const preferred = voices.find(v=>/^en|^de/i.test(v.lang)) || voices[0];
        tts.voice = preferred; voiceSelect.value = preferred?.name || '';
      }
    }

    function setTTSControlsEnabled(on){
      voiceSelect.disabled = !on; rateInput.disabled = !on; pitchInput.disabled = !on; testVoiceBtn.disabled = !on; muteBtn.disabled = !on;
    }

    function speak(text){
      if(!tts.enabled || tts.muted || !('speechSynthesis' in window)) return;
      try{ window.speechSynthesis.cancel(); }catch(e){}
      const u = new SpeechSynthesisUtterance(text);
      if(tts.voice) u.voice = tts.voice;
      u.rate = tts.rate; u.pitch = tts.pitch; u.volume = tts.volume;
      window.speechSynthesis.speak(u);
    }

    function stopSpeak(){ if('speechSynthesis' in window) try{ window.speechSynthesis.cancel(); }catch(e){} }

    // Restore TTS settings on load
    (function initTTS(){
      try{
        tts.enabled = localStorage.getItem('sentence-trainer:tts') === '1';
        tts.rate = parseFloat(localStorage.getItem('sentence-trainer:rate')||'1')||1;
        tts.pitch = parseFloat(localStorage.getItem('sentence-trainer:pitch')||'1')||1;
        tts.muted = localStorage.getItem('sentence-trainer:muted') === '1';
        ttsEnabled.checked = tts.enabled; rateInput.value = tts.rate; pitchInput.value = tts.pitch;
        setTTSControlsEnabled(tts.enabled);
        muteBtn.textContent = tts.muted ? 'ðŸ”ˆ' : 'ðŸ”Š';
        if('speechSynthesis' in window){
          loadVoices();
          // Some browsers (esp. Safari/iOS) populate voices asynchronously
          window.speechSynthesis.onvoiceschanged = loadVoices;
        } else {
          document.getElementById('ttsSupportNote').innerHTML = 'Your browser does not support Textâ€‘toâ€‘Speech.';
        }
      }catch(e){}
    })();

    function startSentenceCycle(){
      if(i>=sentences.length){
        // Finished all
        stage.innerHTML = `<div class="write">All done âœ…</div>`;
        setCountdownLabel('Complete', 'idle');
        nextBtn.disabled = true;
        animateBar(0);
        return;
      }
      updateIndex();
      phase = 'show';
      stage.textContent = sentences[i];
      // Speak at the start of show phase
      stopSpeak();
      speak(sentences[i]);
      nextBtn.disabled = true; // only enabled in 'write' and 'again'
      startTimer(5000, 'Show', 'show', ()=>{
        phase = 'blank';
        stage.textContent = '';
        stopSpeak();
        startTimer(3000, 'Blank', 'blank', ()=>{
          phase = 'write';
          stage.innerHTML = `<div class="write">WRITE</div>`;
          setCountdownLabel('Wait for Next', 'idle');
          animateBar(0);
          nextBtn.disabled = false; // allow progressing
        });
      });
    }

    function handleNext(){
      if(phase === 'write'){
        // Show the same sentence again (no timer)
        phase = 'again';
        stage.textContent = sentences[i];
        setCountdownLabel('Repeat shown', 'idle');
        animateBar(0);
        stopSpeak();
        speak(sentences[i]);
        nextBtn.disabled = false;
      } else if(phase === 'again'){
        // Move to next sentence
        i++;
        stopSpeak();
        startSentenceCycle();
      } else if(phase === 'idle' && i<sentences.length){
        startSentenceCycle();
      }
    }

    // Controls
    startBtn.addEventListener('click', ()=>{
      const list = parseSentences(input.value);
      if(list.length===0){
        alert('Please add at least one sentence.');
        return;
      }
      // Persist to localStorage for convenience
      try{ localStorage.setItem('sentence-trainer:last', JSON.stringify(list)); }catch(e){}
      gotoViewer(list);
    });

    demoBtn.addEventListener('click', ()=>{
      const demo = [
        'Ich mag Mathe, weil es logisch ist.',
        'Am Montag habe ich Deutsch.',
        'Wir spielen FuÃŸball nach der Schule.',
        'Im Sommer fahre ich nach Spanien.'
      ];
      input.value = demo.join('\n');
    });

    clearBtn.addEventListener('click', ()=>{ input.value=''; input.focus(); });

    nextBtn.addEventListener('click', handleNext);

    restartBtn.addEventListener('click', ()=>{
      clearInterval(timer);
      stopSpeak();
      startSentenceCycle();
    });

    backBtn.addEventListener('click', ()=>{
      clearInterval(timer);
      stopSpeak();
      viewer.style.display='none'; setup.style.display='block';
      nextBtn.disabled = true; stage.textContent=''; animateBar(0);
    });

    // Keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      // Space for Next (but not when typing in textarea)
      if(e.code === 'Space'){
        const active = document.activeElement;
        if(active && (active.tagName === 'TEXTAREA' || active.tagName === 'INPUT')) return; 
        e.preventDefault();
        if(viewer.style.display === 'block' && !nextBtn.disabled){ handleNext(); }
      }
    });

    // TTS control listeners
    ttsEnabled.addEventListener('change', ()=>{
      tts.enabled = ttsEnabled.checked;
      setTTSControlsEnabled(tts.enabled);
      localStorage.setItem('sentence-trainer:tts', tts.enabled ? '1' : '0');
      if(!tts.enabled) stopSpeak();
    });
    voiceSelect.addEventListener('change', ()=>{
      const name = voiceSelect.value;
      const list = (window.speechSynthesis && window.speechSynthesis.getVoices()) || [];
      tts.voice = list.find(v=>v.name===name)||null;
      localStorage.setItem('sentence-trainer:voice', name||'');
    });
    rateInput.addEventListener('input', ()=>{
      tts.rate = parseFloat(rateInput.value)||1; localStorage.setItem('sentence-trainer:rate', String(tts.rate));
    });
    pitchInput.addEventListener('input', ()=>{
      tts.pitch = parseFloat(pitchInput.value)||1; localStorage.setItem('sentence-trainer:pitch', String(tts.pitch));
    });
    testVoiceBtn.addEventListener('click', ()=>{
      stopSpeak(); speak('This is a test of the selected voice.');
    });
    muteBtn.addEventListener('click', ()=>{
      tts.muted = !tts.muted; localStorage.setItem('sentence-trainer:muted', tts.muted ? '1' : '0');
      muteBtn.textContent = tts.muted ? 'ðŸ”ˆ' : 'ðŸ”Š';
      if(tts.muted) stopSpeak();
    });

    // Load last session if available
    try{
      const last = JSON.parse(localStorage.getItem('sentence-trainer:last')||'null');
      if(Array.isArray(last) && last.length){ input.value = last.join('\n'); }
    }catch(e){}

    // ---------------- Self-tests ----------------
    (function selfTests(){
      const cases = [
        {name:'LF only', input:'A\nB\n\n C ', expected:['A','B','C']},
        {name:'CRLF',    input:'A\r\nB\r\n\r\nC', expected:['A','B','C']},
        {name:'CR only', input:'A\rB\r\rC', expected:['A','B','C']},
        {name:'Spaces',  input:'  A  \n  \n B ', expected:['A','B']}
      ];
      let pass = 0;
      for(const t of cases){
        const out = parseSentences(t.input);
        const ok = JSON.stringify(out)===JSON.stringify(t.expected);
        console[ok?'log':'error'](`[parseSentences] ${ok?'PASS':'FAIL'} - ${t.name}`, {out, expected:t.expected});
        if(ok) pass++;
      }
      console[pass===cases.length?'log':'error'](`[parseSentences] ${pass}/${cases.length} tests passed`);
    })();
  </script>
</body>
</html>
